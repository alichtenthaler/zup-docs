<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Instalação - ZUP – Zeladoria Urbana Participativa</title>
  

  <link rel="shortcut icon" href="../images/favicon.ico">
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  <link href="../css/main.css" rel="stylesheet">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Instalação";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 
  <script src="../javascript/main.js"></script>

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> ZUP – Zeladoria Urbana Participativa</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <ul class="subnav">
    <li><span>Sobre a plataforma</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="..">Introdução</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../implement/">Como adotar a plataforma</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Obtenha os softwares</span></li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Instalação</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#instalacao">Instalação</a></li>
                
                    <li><a class="toctree-l4" href="#pre-requisito-docker">Pré-requisito: Docker</a></li>
                
                    <li><a class="toctree-l4" href="#pre-requisito-supervisord">Pré-requisito: Supervisord</a></li>
                
                    <li><a class="toctree-l4" href="#crie-os-diretorios-para-manter-os-dados-do-sistema">Crie os diretórios para manter os dados do sistema</a></li>
                
                    <li><a class="toctree-l4" href="#crie-os-arquivos-de-configuracao">Crie os arquivos de configuração</a></li>
                
                    <li><a class="toctree-l4" href="#baixe-as-imagens-da-aplicacao">Baixe as imagens da aplicação</a></li>
                
                    <li><a class="toctree-l4" href="#crie-o-arquivo-de-configuracao-do-supervisord">Crie o arquivo de configuração do Supervisord</a></li>
                
                    <li><a class="toctree-l4" href="#configure-o-supervisord-para-iniciar-automaticamente-no-boot">Configure o Supervisord para iniciar automaticamente no boot</a></li>
                
                    <li><a class="toctree-l4" href="#inicialize-o-banco-de-dados">Inicialize o banco de dados</a></li>
                
                    <li><a class="toctree-l4" href="#inicie-o-supervisor">Inicie o supervisor</a></li>
                
                    <li><a class="toctree-l4" href="#inicie-a-aplicacao">Inicie a aplicação</a></li>
                
                    <li><a class="toctree-l4" href="#opcional-importe-um-banco-de-dados-ja-existente">(Opcional) Importe um banco de dados já existente</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../updating_docker/">Atualização</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Configuração</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../api_configuration/">Configuração da API</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../web_configuration/">Configuração dos aplicativos Web</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">ZUP – Zeladoria Urbana Participativa</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Obtenha os softwares &raquo;</li>
        
      
    
    <li>Instalação</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="instalacao">Instalação</h1>
<p>A distribuição das aplicações em forma já compilada para uso é feita através do Docker.
<a href="https://docs.docker.com/">Docker</a> é uma tecnologia para distribuição e execução de aplicações virtualizadas a nível de 
sistema operacional. A maneira mais simples e eficaz de se manter uma instalação do ZUP é utilizando as imagens dos 
componentes que disponibilizamos no Docker Hub. Este documento descreve as etapas para instalar e executar os 
componentes básicos para rodar a API e as aplicações web do ZUP no sistema operacional Ubuntu 14.04 64 bits. Entretanto
qualquer sistema operacional que suporte Docker deve funcionar com os passos abaixo, salvo que você precisará utilizar o
gerenciador de pacotes do seu sistema operacional ao invés do <code>apt</code> e talvez tenha que desabilitar o SELinux, caso 
venha habilitado por padrão na sua distribuição. Além disso, utilizamos o <a href="../supervisord.org">Supervisord</a> para gerenciar
a execução dos containers da aplicação, incluindo a inicialização dos containers junto com o sistema e a reinicialização
dos mesmos em caso de erros.</p>
<p>As necessidades de recursos de hardware depende da volumetria esperada pelo projeto, entretanto no mínimo recomendamos 
6GB de RAM e dois núcleos de processamento dedicados.</p>
<h2 id="pre-requisito-docker">Pré-requisito: Docker</h2>
<p>O sistema de instalação do Docker via Ubuntu requer a execução de um único script de instalação:</p>
<pre><code class="bash">wget -qO- https://get.docker.com/ | sh
</code></pre>

<p>Você receberá um erro caso seu sistema não possua o <code>wget</code> instalado. Neste caso basta executar:</p>
<pre><code class="bash">sudo apt-get update
sudo apt-get install wget
wget -qO- https://get.docker.com/ | sh
</code></pre>

<p>Após a instalação, caso você não rode os comandos abaixo como root, recomendamos que adicione o usuário no grupo do 
Docker para rodar os comandos sem necessidade do sudo. Recomendamos que você leia as condireções de segurança do Docker
em ambos os casos: <a href="https://docs.docker.com/articles/security/">https://docs.docker.com/articles/security/</a>.</p>
<pre><code>sudo gpasswd -a ${USER} docker
</code></pre>

<h2 id="pre-requisito-supervisord">Pré-requisito: Supervisord</h2>
<p>O supervisord é distribuido através do PyPI e pode ser instalado através do <code>easy_install</code>.</p>
<pre><code class="bash">sudo apt-get install python-setuptools
sudo easy_install supervisor
</code></pre>

<h2 id="crie-os-diretorios-para-manter-os-dados-do-sistema">Crie os diretórios para manter os dados do sistema</h2>
<p>Para persistir informações em containers Docker é necessário criar diretórios (<strong>volume</strong> no jargão Docker) para manter 
os dados no sistema de arquivos do host (o sistema que hospeda o serviço do Docker). Para fins desta documentação 
manteremos todos os diretórios de dados, configurações e logs na pasta <code>/opt/zup</code>. Você pode alterar a localização de 
cada pasta para a hierarquia mais apropriada a sua organização.</p>
<pre><code class="bash">sudo mkdir -p \
    /opt/zup/config \
    /opt/zup/postgres-data \
    /opt/zup/uploads \
    /opt/zup/shared_images \
    /opt/zup/logs/api \
    /opt/zup/logs/nginx
</code></pre>

<h2 id="crie-os-arquivos-de-configuracao">Crie os arquivos de configuração</h2>
<p>Durante a inicialização a API lê uma série de variáveis de configuração do ambiente. Para passar essas configurações via
Docker basta criar um arquivo contendo uma série de chave-valores. 
Veja a seção <a href="../api_configuration/#opcoes-disponiveis">Configuração da API</a> para conhecer as configurações disponíveis.</p>
<p>A versão da plataforma é controlada pelo arquivo <code>/opt/zup/config/version</code> e deve possuir apenas uma linha de código:</p>
<pre><code>1.0.0
</code></pre>

<p>As seguintes opções são obrigatórias. Para fins deste documento o arquivo de configuração da API estará localizado 
em <code>/opt/zup/config/api.env</code>:</p>
<pre><code>WEB_URL=https://www.meuzup.com.br
API_URL=http://api.meuzup.com.br:8282
ASSET_HOST_URL=https://api.meuzup.com.br
SMTP_ADDRESS=smtp.meuservidordeemail.com
SMTP_PORT=587
SMTP_USER=zup@meuservidordeemail.com
SMTP_PASS=102030
SMTP_TTLS=true
SMTP_AUTH=plain
MAIL_HEADER_IMAGE=/usr/src/app/public/shared_images/header.jpg
REDIS_URL=redis://redis:6379
DATABASE_URL=postgis://db_user:db_pass@postgres:5432/zup_db
</code></pre>
<p>Além disso é necessário informar as configurações para inicialização do banco de dados. <code>/opt/zup/config/postgres.env</code>:</p>
<pre><code>POSTGRES_USER=db_user
POSTGRES_PASSWORD=db_pass
POSTGRES_DB=zup_db
</code></pre>
<p>Lembre-se de alterar o <code>api.env</code> quando alterar o <code>postgres.env</code>.</p>
<p>Finalmente, é preciso configurar informações sobre como conectar na API e qual posicionamento deve ser usado no mapa 
para as aplicações web. <code>/opt/zup/config/web.env</code>:</p>
<pre><code>API_URL=http://api.meuzup.com.br:8282
MAP_LAT=-23.689701
MAP_LNG=-46.564874
MAP_ZOOM=11
DISABLE_LANDING_PAGE=true
DISABLE_WEB_APP=true
</code></pre>
<p>Com esta configuração inicial, apenas o Painel Administrativo estará disponível. Para conhecer todas as opções de
configuração, visite a seção <a href="../web_configuration/">Configuração dos aplicativos Web</a>.</p>
<h2 id="baixe-as-imagens-da-aplicacao">Baixe as imagens da aplicação</h2>
<pre><code class="bash">docker pull ntxcode/postgresql:9.4
docker pull institutotim/zup-api:$(cat /opt/zup/config/version)
docker pull institutotim/zup-web:$(cat /opt/zup/config/version)
docker pull redis:2.8
</code></pre>

<h2 id="crie-o-arquivo-de-configuracao-do-supervisord">Crie o arquivo de configuração do Supervisord</h2>
<p>O Supervisord será usado para controlar o ciclo de vida da aplicação. Este arquivo de configuração deve ser salvo 
em <code>/etc/supervisord.conf</code>.</p>
<pre><code class="ini">[unix_http_server]
file=/tmp/supervisor.sock

[supervisord]
logfile=/tmp/supervisord.log
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info
pidfile=/tmp/supervisord.pid
minfds=1024
minprocs=200

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[program:redis]
autostart=true
autorestart=true
startsecs=15
command=/bin/bash -c &quot;docker rm -f redis || true &amp;&amp; docker run --rm --name=redis -a stdout -a stderr redis:2.8&quot;
priority=0
redirect_stderr=true
stdout_logfile=/opt/zup/logs/redis.log

[program:postgres]
autostart=true
autorestart=true
startsecs=15
command=/bin/bash -c &quot;docker rm -f postgres || true &amp;&amp; docker run --rm -a stdout -a stderr \
                        --env-file=/opt/zup/config/postgres.env \
                        -v /opt/zup/postgres-data:/var/lib/postgresql/data \
                        -v /etc/localtime:/etc/localtime:ro \
                        --name postgres ntxcode/postgresql:9.4&quot;
priority=1
redirect_stderr=true
stdout_logfile=/opt/zup/logs/postgres.log

[program:zup-web]
autostart=true
autorestart=true
startsecs=15
command=/bin/bash -c &quot;docker rm -f zup-web || true &amp;&amp; docker run --name zup-web --rm -a stdout -a stderr \
                        --env-file=/opt/zup/config/web.env \
                        -v /etc/localtime:/etc/localtime:ro \
                        -v /opt/zup/logs/nginx:/var/log/nginx \
                        -p 80:80 institutotim/zup-web:$(cat /opt/zup/config/version)&quot;
priority=2
redirect_stderr=true
stdout_logfile=/opt/zup/logs/web.log

[program:zup-api]
autostart=true
autorestart=true
startsecs=15
command=/bin/bash -c &quot;docker rm -f zup-api || true &amp;&amp; docker run --rm --link postgres:postgres --link redis:redis \
                        --env-file=/opt/zup/config/api.env \
                        -v /etc/localtime:/etc/localtime:ro \
                        -v /opt/zup/uploads:/usr/src/app/public/uploads \
                        -v /opt/zup/logs/api:/usr/src/app/log \
                        -v /opt/zup/config:/usr/src/app/config/permissions \
                        -v /opt/zup/shared_images:/usr/src/app/public/shared_images \
                        -p 8282:80 --name zup-api institutotim/zup-api:$(cat /opt/zup/config/version)&quot;
priority=3
redirect_stderr=true
stdout_logfile=/opt/zup/logs/api.log
</code></pre>

<h2 id="configure-o-supervisord-para-iniciar-automaticamente-no-boot">Configure o Supervisord para iniciar automaticamente no boot</h2>
<p>Para que o supervisord possa iniciar automaticamente as aplicações ao se iniciar o sistema, é necessário criar um 
arquivo de configuração para inicializá-lo durante o boot. Adicione o seguinte conteúdo em <code>/etc/init/supervisor.conf</code>:</p>
<pre><code>description &quot;supervisor&quot;

start on runlevel [2345]
stop on runlevel [!2345]

respawn

exec /usr/local/bin/supervisord --nodaemon --configuration /etc/supervisord.conf
</code></pre>

<h2 id="inicialize-o-banco-de-dados">Inicialize o banco de dados</h2>
<p>Para criar a estrutura da aplicação no banco de dados, basta executar o comando a baixo:</p>
<pre><code>docker run -it \
       --link redis:redis --link postgres:postgres \
       --env-file=/opt/zup/config/api.env \
       institutotim/zup-api bundle exec rake db:schema:load db:seed
</code></pre>

<p>As credenciais de uma conta de administrador será exibida na saída do comando.</p>
<h2 id="inicie-o-supervisor">Inicie o supervisor</h2>
<p><code>service supervisor start</code></p>
<h2 id="inicie-a-aplicacao">Inicie a aplicação</h2>
<p><code>supervisorctl start all</code></p>
<p>Por padrão a aplicação web estará disponível na porta 80 e a API na porta 8282.</p>
<h2 id="opcional-importe-um-banco-de-dados-ja-existente">(Opcional) Importe um banco de dados já existente</h2>
<p>Caso você esteja atualizando uma instalação já existente, é possível importar um dump do banco de dados da sua aplicação 
com seguinte comando:</p>
<pre><code>docker run -it -v /tmp/folder-containing-sql-file:/tmp --link postgres:postgres ntxcode/postgresql /bin/bash -c &quot;psql --host postgres -U zup -f /tmp/file.sql zup&quot;
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../updating_docker/" class="btn btn-neutral float-right" title="Atualização"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../implement/" class="btn btn-neutral" title="Como adotar a plataforma"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright TIM Celular 2015 - Todos direitos reservados. Licenciado através da <a href="https://www.gnu.org/licenses/gpl-2.0.html" target="_blank">GPL v2</a>.</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../implement/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../updating_docker/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
